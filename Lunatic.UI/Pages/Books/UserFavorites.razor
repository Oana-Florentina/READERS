@page "/userFavorites"
@using Lunatic.UI.Contracts
@using Lunatic.UI.ViewModels
@using Lunatic.UI.Payload;
@inject ITokenService tokenService
@inject IUserDataService UserDataService
@inject NavigationManager NavigationManager
@inject IReaderDataService ReaderDataService
@inject IRatingDataService RatingDataService
@inject IBookDataService BookDataService

<h3>My favorites books</h3>

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else if (!Books.Any())
{
    <p>No favorites books to display.</p>
}
else
{
    <table class="table table-responsive table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Year</th>
                <th>Genres</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var book in Books)
            {
                <tr>
                    <td>@book.Title</td>
                    <td>@book.Author</td>
                    <td>@book.Year</td>
                    <td>
                        @if (book.Genres != null && book.Genres.Any())
                        {
                            @string.Join(", ", book.Genres)
                        }
                        else
                        {
                            <span>No genres available</span>
                        }
                    </td>
                    
                </tr>
            }
        </tbody>
    </table>
}

<!-- Modal for showing reader details -->


@code {
    [Parameter]
    public Guid userId { get; set; }

    [Inject]
    public IDataService dataService { get; set; }

    public List<BookViewModel> Books { get; set; } = new();
    private bool isLoading { get; set; } = false;
    private bool IsModalVisible { get; set; } = false;
    private BookDto SelectedFav { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadBooks();
    }

    private async Task LoadBooks()
    {
        if (isLoading)
        {
            return;
        }

        isLoading = true;

        try
        {
            Books.Clear();

            var userId = await dataService.GetItemAsync<Guid>("UserId");
            Console.WriteLine($"UserId: {userId}");

            var readers = await UserDataService.GetBooksIReadByIdsAsync(userId);

            foreach (var reader in readers)
            {
                var book = await BookDataService.GetBookByIdAsync(reader.BookId);
                if (book != null)
                {
                    Books.Add(book);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading read books: {ex.Message}");
            // Handle the error (e.g., show a message or redirect)
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CloseModal()
    {
        IsModalVisible = false;
    }

    private void NavigateToBook(Guid bookId)
    {
        NavigationManager.NavigateTo($"/book/{bookId}");
    }
}
